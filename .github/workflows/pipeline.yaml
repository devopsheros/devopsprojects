name: application

on:
  push:
    branches:
      - 'main'
  pull_request:
  workflow_dispatch:
    inputs:
      branches:
        description: 'Branch to deploy'
        required: true

jobs:
  infrastructure:
    name: 'terraform'
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v3

      - name: Set up Terraform
        uses: hashicorp/setup-terraform@v1

      - name: Create Terraform backend configuration
        run: |
          cd terraform
          echo '  backend "gcs" {' >> backend.tf
          echo '    bucket  = "${{ secrets.BUCKETS_NAME }}"' >> backend.tf
          echo '    prefix  = "${{ secrets.BUCKET_PREFIX }}"' >> backend.tf
          echo '    credentials = "../credentials.json"' >> backend.tf
          echo '  }' >> backend.tf
          echo '  required_providers {' >> backend.tf
          echo '     google = {' >> backend.tf
          echo '       source  = "hashicorp/google"' >> backend.tf
          echo '       version = "4.66.0"' >> backend.tf
          echo '     }' >> backend.tf
          echo '  }' >> backend.tf

      - name: Create credentials file
        run: |
          echo "${{ secrets.GOOGLE_CREDENTIALS }}" > credentials.json

      - name: Fetch remote state
        run: |
          cd terraform
          terraform init -backend-config=backend.tf

      - name: plan
        id: terraform_plan
        run: |
          cd terraform
          terraform plan -var-file=values.tfvars
          echo ${{ steps.terraform_plan.outputs.stdout }}
          echo ${{ steps.terraform_plan.outputs.stderr }}
          echo ${{ steps.terraform_plan.outputs.exitcode }}

      - name: apply
        id: terraform_apply
        if: github.ref == 'refs/heads/main' && github.event_name == 'main'
        run: |
          terraform apply  -var-file=values.tfvars -auto-approve
          echo ${{ steps.terraform_apply.outputs.stdout }}
          echo ${{ steps.terraform_apply.outputs.stderr }}
          echo ${{ steps.terraform_apply.outputs.exitcode }}
